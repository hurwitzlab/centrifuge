BootStrap: docker
From: ubuntu:latest

%environment
    PATH=/app/centrifuge/scripts:$PATH
    LD_LIBRARY_PATH=/app
    export LD_LIBRARY_PATH

%runscript
    exec /app/centrifuge/centrifuge "$@"

%post
    apt-get update
    apt-get install -y locales git build-essential wget curl zip \
        libcurl4-openssl-dev libssl-dev python3 python3-pip gpg parallel
    locale-gen en_US.UTF-8

    mkdir /root/.parallel
    touch /root/.parallel/will-cite

    #
    # Put everything into $APP_DIR
    #
    mkdir -p /app
    cd /app

    wget -O centrifuge.tgz https://github.com/infphilo/centrifuge/archive/v1.0.4-beta.tar.gz
    tar xvf centrifuge.tgz
    cd centrifuge-1.0.4-beta
    make && make install

    cd /app
    git clone https://github.com/hurwitzlab/centrifuge.git
    python3 -m pip install biopython

    #
    # Add CRAN to sources to get latest R
    #
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E084DAB9
    apt-get install -y r-base r-base-dev

    cat << EOF > .Rprofile
local({
  r = getOption("repos")
  r["CRAN"] = "http://mirrors.nics.utk.edu/cran/"
  options(repos = r)
})
EOF
    /usr/bin/Rscript /app/centrifuge/scripts/install.r

    #
    # Mount points for TACC directories
    #
    mkdir /home1
    mkdir /scratch
    mkdir /work

    # 
    # Mount points for Ocelote
    # 
    #mkdir /extra 
    #mkdir /xdisk 
    #mkdir /rsgrps
